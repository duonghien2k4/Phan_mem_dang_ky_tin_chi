<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký tín chỉ</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script defer src="script.js"></script>
</head>
<body>
    <div class="sidebar">
        <a onclick="showSection('student-info')">Thông tin học sinh</a>
        <a onclick="showSection('course-list')">Danh sách môn học</a>
        <a onclick="showSection('teacher-list')">Giáo viên</a>
        <a onclick="showSection('schedule')">Thời khóa biểu</a>
        <a onclick="showSection('registration')">Đăng ký học</a>
        <button class="logout-button" onclick="logout()">Đăng xuất</button>
    </div>
    <div class="content">
        <h2>Chào mừng, <span id="user-email"></span></h2>
        <div id="registration" class="registration">
            <h2>Đăng ký học</h2>
            <div id="course-container" class="course-container"></div>
            <div id="class-container" class="class-container"></div>
            <h3>Lớp đã đăng ký:</h3>
            <ul id="registered-classes"></ul>
        </div>

        <div id="student-info" class="student-info" style="display: none;">
            <div class="student-info-container">
                <img id="student-avatar" src="default-avatar.png" alt="Ảnh đại diện" class="avatar">
                <div class="student-info-content">
                    <div class="student-info-title">THÔNG TIN CƠ BẢN</div>
                    <div class="student-info-grid">
                        <p><strong>Mã SV:</strong> <input type="text" id="student-id" disabled></p>
                        <p><strong>Họ và đệm:</strong> <input type="text" id="student-lastname" disabled></p>
                        <p><strong>Ngày sinh:</strong> <input type="date" id="student-dob" disabled></p>
                        <p><strong>Tên:</strong> <input type="text" id="student-firstname" disabled></p>
                        <p><strong>Khóa đào tạo:</strong> <input type="text" id="student-course" disabled></p>
                        <p><strong>Lớp:</strong> <input type="text" id="student-class" disabled></p>
                        <p><strong>Niên khóa:</strong> <input type="text" id="student-year" disabled></p>
                        <p><strong>Khoa quản lý:</strong> <input type="text" id="student-faculty" disabled></p>
                        <p><strong>Email:</strong> <input type="email" id="student-email" disabled></p>
                        <p><strong>Ngành:</strong> <input type="text" id="student-major" disabled></p>
                        <p><strong>Giới tính:</strong> 
                            <select id="student-gender" disabled>
                                <option value="Nam">Nam</option>
                                <option value="Nữ">Nữ</option>
                                <option value="Khác">Khác</option>
                            </select>
                        </p>
                        <p><strong>Hệ đào tạo:</strong> <input type="text" id="student-system" disabled></p>
                        <p><strong>Trạng thái:</strong> <input type="text" id="student-status" disabled></p>
                        <p><strong>Chức vụ:</strong> <input type="text" id="student-role" disabled></p>
                        <p><strong>Chương trình đào tạo:</strong> <input type="text" id="student-program" disabled></p>
                    </div>
                    <button id="edit-info-btn" onclick="enableEdit()">Cập nhật thông tin</button>
                    <button id="save-info-btn" onclick="saveStudentInfo()" style="display: none;">Lưu thông tin</button>
                </div>
            </div>
            
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDla-CSFtR6-y2vscJjuX6Q0vp0x0TTLT4",
            authDomain: "dangkytinchi-73b7a.firebaseapp.com",
            projectId: "dangkytinchi-73b7a",
            storageBucket: "dangkytinchi-73b7a.appspot.com",
            databaseURL: "https://dangkytinchi-73b7a-default-rtdb.firebaseio.com",
            messagingSenderId: "1013393708459",
            appId: "1:1013393708459:web:21be9269a148ed83386eee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase();
        const auth = getAuth();

        let currentUserEmail = "";
        let currentUserId = "";

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserEmail = user.email;
                currentUserId = user.email.split('@')[0];
                document.getElementById("user-email").textContent = currentUserEmail;
               
                loadStudentInfo();
                loadCourses();
                loadRegisteredClasses();
            } else {
                window.location.href = "login.html";
            }
        });
        function loadStudentInfo() {
    const studentRef = ref(db, `students/${currentUserId}`);
    console.log("Current User ID:", currentUserId);

    get(studentRef).then(snapshot => {
        if (snapshot.exists()) {
            const data = snapshot.val();
            document.getElementById("student-id").value = data.studentId || "";
            document.getElementById("student-lastname").value = data.lastname || "";
            document.getElementById("student-firstname").value = data.firstname || "";
            document.getElementById("student-dob").value = data.dob || "";
            document.getElementById("student-course").value = data.course || "";
            document.getElementById("student-class").value = data.class || "";
            document.getElementById("student-year").value = data.year || "";
            document.getElementById("student-faculty").value = data.faculty || "";
            document.getElementById("student-email").value = data.email || "";
            document.getElementById("student-major").value = data.major || "";
            document.getElementById("student-gender").value = data.gender || "Nam";
            document.getElementById("student-system").value = data.system || "";
            document.getElementById("student-status").value = data.status || "";
            document.getElementById("student-role").value = data.role || "";
            document.getElementById("student-program").value = data.program || "";

            // Kiểm tra và hiển thị ảnh đại diện nếu có
            const avatar = document.getElementById("student-avatar");
            avatar.src = data.avatar ? data.avatar : "default-avatar.png";
        }
    }).catch(error => {
        console.error("Lỗi khi tải thông tin học sinh:", error);
    });
}

        function enableEdit() {
            document.querySelectorAll(".student-info-grid input, .student-info-grid select").forEach(input => {
                input.disabled = false;
            });
            document.getElementById("edit-info-btn").style.display = "none";
            document.getElementById("save-info-btn").style.display = "inline-block";
        }


        function saveStudentInfo() {
    const studentData = {
        studentId: document.getElementById("student-id").value,
        lastname: document.getElementById("student-lastname").value,
        firstname: document.getElementById("student-firstname").value,
        dob: document.getElementById("student-dob").value,
        course: document.getElementById("student-course").value,
        class: document.getElementById("student-class").value,
        year: document.getElementById("student-year").value,
        faculty: document.getElementById("student-faculty").value,
        email: document.getElementById("student-email").value,
        major: document.getElementById("student-major").value,
        gender: document.getElementById("student-gender").value,
        system: document.getElementById("student-system").value,
        status: document.getElementById("student-status").value,
        role: document.getElementById("student-role").value,
        program: document.getElementById("student-program").value
    };

    update(ref(db, `students/${currentUserId}`), studentData)
        .then(() => {
            alert("Cập nhật thông tin thành công!");
            document.querySelectorAll(".student-info-grid input, .student-info-grid select").forEach(input => {
                input.disabled = true;
            });
            document.getElementById("edit-info-btn").style.display = "inline-block";
            document.getElementById("save-info-btn").style.display = "none";
        })
        .catch(error => {
            console.error("Lỗi khi cập nhật thông tin:", error);
            alert("Có lỗi xảy ra khi cập nhật. Vui lòng thử lại!");
        });
}
        function loadCourses() {
            const courseContainer = document.getElementById("course-container");
            courseContainer.innerHTML = "";
            
            const courses = [
                { id: "CT101", name: "Lập trình C++" },
                { id: "CT102", name: "Cấu trúc dữ liệu" }
            ];

            courses.forEach(course => {
                const courseBox = document.createElement("div");
                courseBox.className = "course-box";
                courseBox.textContent = course.name;
                courseBox.onclick = () => showClasses(course.id);
                courseContainer.appendChild(courseBox);
            });
        }

        function showClasses(courseId) {
            const classContainer = document.getElementById("class-container");
            classContainer.innerHTML = "";
            
            const classes = {
                "CT101": [
                    { id: "CT101-L1", time: "Thứ 2, 8:00-10:00", teacher: "Nguyễn Văn A" }
                ],
                "CT102": [
                    { id: "CT102-L1", time: "Thứ 4, 8:00-10:00", teacher: "Phạm Văn C" }
                ]
            };

            if (classes[courseId]) {
                classes[courseId].forEach(cls => {
                    const classBox = document.createElement("div");
                    classBox.className = "class-box";
                    classBox.innerHTML = `<strong>${cls.time}</strong><br>Giáo viên: ${cls.teacher}`;
                    classBox.onclick = () => registerClass(cls.id);
                    classContainer.appendChild(classBox);
                });
            }
        }

        function registerClass(classId) {
            const userRef = ref(db, `students/${currentUserId}/registeredClasses/${classId}`);
            set(userRef, true).then(() => {
                alert(`Đăng ký thành công lớp ${classId}`);
                loadRegisteredClasses();
            });
        }

        function loadRegisteredClasses() {
            const registeredList = document.getElementById("registered-classes");
            registeredList.innerHTML = "";
            
            get(ref(db, `students/${currentUserId}/registeredClasses`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const classes = snapshot.val();
                    Object.keys(classes).forEach(classId => {
                        const li = document.createElement("li");
                        li.textContent = classId;
                        const removeBtn = document.createElement("button");
                        removeBtn.textContent = "Hủy";
                        removeBtn.onclick = () => unregisterClass(classId);
                        li.appendChild(removeBtn);
                        registeredList.appendChild(li);
                    });
                }
            });
        }

        function unregisterClass(classId) {
            remove(ref(db, `students/${currentUserId}/registeredClasses/${classId}`)).then(() => {
                alert(`Hủy đăng ký lớp ${classId} thành công`);
                loadRegisteredClasses();
            });
        }

        function logout() {
            signOut(auth).then(() => {
                window.location.href = "login.html";
            });
        }
    </script>
</body>
</html>
