<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký tín chỉ</title>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script type="module" src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js"></script>
    <script type="module">
        // Cấu hình Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, get, child, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDla-CSFtR6-y2vscJjuX6Q0vp0x0TTLT4",
            authDomain: "dangkytinchi-73b7a.firebaseapp.com",
            projectId: "dangkytinchi-73b7a",
            storageBucket: "dangkytinchi-73b7a.appspot.com",
            databaseURL: "https://dangkytinchi-73b7a-default-rtdb.firebaseio.com",
            messagingSenderId: "1013393708459",
            appId: "1:1013393708459:web:21be9269a148ed83386eee"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // Danh sách môn học mẫu
        const subjects = ["YH"]; 
        const classes = {};

        subjects.forEach(subject => {
            for (let i = 1; i <= 5; i++) {
                const classId = `${subject}${i}`;
                classes[classId] = { subject: subject, schedule: `Thứ ${Math.ceil(Math.random() * 6)} - Tiết ${Math.ceil(Math.random() * 5)}` };
            }
        });

        set(ref(db, "subjects"), subjects.reduce((acc, subj) => ({ ...acc, [subj]: true }), {}));
        set(ref(db, "classes"), classes);

        // Hiển thị danh sách lớp học
        async function displayClasses() {
            const dbRef = ref(db);
            const classSnap = await get(child(dbRef, "classes"));
            if (classSnap.exists()) {
                const classList = document.getElementById("classList");
                classList.innerHTML = "";
                Object.entries(classSnap.val()).forEach(([id, data]) => {
                    const li = document.createElement("li");
                    li.textContent = `${id}: ${data.subject} - ${data.schedule}`;
                    classList.appendChild(li);
                });
            }
        }

        // Hiển thị danh sách môn học đăng ký của sinh viên
        async function displayStudentClasses() {
            const studentId = document.getElementById('studentId').value.trim();
            if (!studentId) {
                alert("Vui lòng nhập mã sinh viên!");
                return;
            }
            const dbRef = ref(db);
            const regSnap = await get(child(dbRef, `registrations/${studentId}`));
            const classList = document.getElementById("studentClasses");
            classList.innerHTML = "";
            if (regSnap.exists()) {
                Object.keys(regSnap.val()).forEach(classId => {
                    const li = document.createElement("li");
                    li.textContent = classId;
                    classList.appendChild(li);
                });
            } else {
                classList.innerHTML = "<li>Không có lớp học nào</li>";
            }
        }

        window.registerClass = async function () {
            const studentId = document.getElementById('studentId').value.trim();
            const classId = document.getElementById('classId').value.trim();

            if (!studentId || !classId) {
                alert("Vui lòng nhập đầy đủ thông tin!");
                return;
            }

            const dbRef = ref(db);
            const studentRegSnap = await get(child(dbRef, `registrations/${studentId}`));
            const classSnap = await get(child(dbRef, `classes/${classId}`));

            if (!classSnap.exists()) {
                alert("Lớp học không tồn tại!");
                return;
            }

            const newClassSchedule = classSnap.val().schedule;
            const existingClasses = studentRegSnap.exists() ? Object.keys(studentRegSnap.val()) : [];

            for (const existingClassId of existingClasses) {
                const existingClassSnap = await get(child(dbRef, `classes/${existingClassId}`));
                if (existingClassSnap.exists() && existingClassSnap.val().schedule === newClassSchedule) {
                    alert("Bạn đã đăng ký lớp trùng lịch!");
                    return;
                }
            }

            update(ref(db, `registrations/${studentId}`), { [classId]: true });
            update(ref(db, `classes/${classId}/students`), { [studentId]: true });

            alert("Đăng ký thành công!");
            displayStudentClasses();
        };

        window.onload = displayClasses;
    </script>
</head>

<body>
    <h2>Đăng ký lớp học</h2>
    <label for="studentId">Mã sinh viên:</label>
    <input type="text" id="studentId" placeholder="Nhập mã sinh viên"><br>

    <label for="classId">Mã lớp học:</label>
    <input type="text" id="classId" placeholder="Nhập mã lớp học"><br>

    <button onclick="registerClass()">Đăng ký</button>
    <button onclick="displayStudentClasses()">Xem lớp đã đăng ký</button>

    <h3>Danh sách lớp học</h3>
    <ul id="classList"></ul>

    <h3>Lớp học đã đăng ký</h3>
    <ul id="studentClasses"></ul>
</body>

</html>
